RFC           Модель пользовательского интерфейса          Сентябрь 2025

         Минимальная модель виджетов пользовательского
             интерфейса и диспетчеризации событий

Статус: Черновик
Категория: Информационный
Аудитория: Разработчики UI-фреймворков и приложений

Оглавление

   1   Аннотация ......................................................1
   2   Термины и определения ..........................................2
   3   Область действия ...............................................3
   4   Геометрическая модель ..........................................3
   5   Глобальное состояние ...........................................3
   6   Типы событий ...................................................3
   7   Модель обработки и распространения событий .....................4
   7.1   Общий маршрут ................................................4
   7.2   Порядок обхода детей .........................................4
   7.3   Результат обработки ..........................................4
   7.4   Условие остановки ............................................4
   8   Выбор целевого виджета .........................................4
   9   События указателя ..............................................5
   10   Отрисовка .....................................................5
   11   Расширяемость интерфейсов .....................................5
   12   Инварианты и требования к совместимости .......................6
   13   Соображения безопасности ......................................6
   14   Соображения производительности ................................6
   15   Соответствие ..................................................6
   16   История изменений .............................................7

1. Аннотация

   Этот документ определяет минимальную, языконезависимую модель
   пользовательского интерфейса на основе иерархии "виджетов",
   глобального состояния UI и системы событий.

   Спецификация описывает: геометрию и вложенность виджетов, типы
   событий, правила распространения событий сверху вниз, критерии
   "попадания" указателя и выбор целевого виджета.

   Документ намеренно избегает привязки к конкретным типам данных или
   синтаксису конкретного языка. Термины "ДОЛЖЕН" (MUST), "НЕ ДОЛЖЕН"
   (MUST NOT), «СЛЕДУЕТ» (SHOULD), «МОЖЕТ» (MAY) читаются согласно
   [RFC 2119]-подобной трактовке нормативности.







Коллективный разум         Предложение черновика            [Страница 1]

RFC           Модель пользовательского интерфейса          Сентябрь 2025


2. Термины и определения

   Виджет (Widget)
      Элемент пользовательского интерфейса с прямоугольной областью и
      необязательными дочерними виджетами.

   Прямоугольник виджета (Rect)
      Набор параметров `x`, `y`, `w`, `h`, где `x`, `y` заданы
      относительно прямоугольника родителя.

   Иерархия
      Ориентированное дерево, где каждый виджет имеет не более одного
      родителя.

   Слой (Z-порядок)
      Упорядочение детей по убыванию "высоты"; элементы с большим Z
      располагаются "выше". Любой ребёнок считается выше своего
      родителя. Так, самым низкий (Z = min) элемент считается
      корень иерархии, а выше всех членов иерархии считается курсор.

   Глобальное состояние
      Синглтон-контекст, содержащий общие параметры окружения и
      служебные указатели (см. раздел 5).

   Событие
      Сообщение о взаимодействии пользователя/системы
      (например, перемещение мыши, нажатие).


   Обработчик события
      Процедура, принимающая событие и возвращающая результат обработки
      (см. раздел 7.3).

   Попадание
      Факт, что координаты события попадают в прямоугольник виджета.

   Целевой виджет (Target)
      Наиболее вложенный виджет, удовлетворяющий правилам выбора цели
      (см. раздел 8).











Коллективный разум         Предложение черновика            [Страница 2]

RFC           Модель пользовательского интерфейса          Сентябрь 2025


3. Область действия

   Спецификация покрывает только:

      - Модель геометрии и вложенности;

      - Типы событий и их распространение;

      - Требования к выбору целевого виджета.

   Отрисовка, ввод с клавиатуры, фокус, доступность, анимации и разметка
   не нормируются, если явно не указано.

4. Геометрическая модель

   Каждый виджет ДОЛЖЕН иметь прямоугольник `Rect` в системе координат
   родителя.

   Операция "содержит точку" ДОЛЖНА определять, лежит ли точка в
   прямоугольнике виджета. Способ преобразования координат из абсолютных
   в "относительные" остаётся вне спецификации, но ДОЛЖЕН быть
   согласован для всей иерархии.

   Если у виджета есть дочерние элементы, они ДОЛЖНЫ быть упорядочены
   по убыванию Z.

5. Глобальное состояние

   Состояние ДОЛЖНО предоставлять по крайней мере:

      - Состояние указателя - Текущее положение и произвольные метаданные
        (кнопки, модификаторы и т.п.).

      - Поле `target` - указатель на целевой виджет (см. раздел 8).

   Состояние МОЖЕТ содержать дополнительные поля и обратные вызовы
   (например, текущее время, глобальные обработчики).

6. Типы событий

   Предлагается следующая иерархия событий:

      - CoordEvent: Координатное событие - содержит
        по крайней мере `x`, `y` (координаты в согласованной системе)

      - MouseMoveEvent: Перемещение указателя - является CoordEvent

      - ClickEvent: Нажатие - является CoordEvent


Коллективный разум         Предложение черновика            [Страница 3]

RFC           Модель пользовательского интерфейса          Сентябрь 2025


      - UnclickEvent: Отжатие - может не содержать координат

   Набор событий МОЖЕТ быть расширен иными типами (например, колесо,
   перетаскивание), не нарушая настоящие правила распространения,
   а также разделён на множество типов событий, отличное от
   представленного.

7. Модель обработки и распространения событий

7.1. Общий маршрут

   События распространяются от корневого виджета вниз по дереву.
   Для событий указателя мыши передача потомкам выполняется только если
   родитель удовлетворяет проверке попадания для координат события.

7.2. Порядок обхода детей

   Обход детей ДОЛЖЕН следовать порядку убывания Z.

7.3. Результат обработки

   Вводится абстрактный результат обработчика:

      - CONSUME - обработка завершена, дальнейшее распространение
        прекращается

      - PROPAGATE - событие может передаваться далее по текущему пути

   Реализация МОЖЕТ отображать эти результаты на булевы значения или
   перечисления, но поведение ДОЛЖНО соответствовать семантике выше.

7.4. Условие остановки

   При первом возвращении результата CONSUME любым участником цепочки
   распространение события ДОЛЖНО быть немедленно прекращено.

8. Выбор целевого виджета

   Перед обработкой каждого MouseMoveEvent поле `target` глобального
   состояния ДОЛЖНО быть сброшено (установлено в неопределённое/пустое
   значение).









Коллективный разум         Предложение черновика            [Страница 4]

RFC           Модель пользовательского интерфейса          Сентябрь 2025


   В ходе нисходящего обхода, первый виджет, удовлетворяющий
   одновременно:

      - Проверке попадания координат события в его прямоугольник;

      - Отсутствию дочерних виджетов.

   ДОЛЖЕН быть назначен в поле `target` глобального состояния.

      Примечание: если требуется иное правило (например, "первый виджет,
      у которого есть обработчик"), это расширение ДОЛЖНО быть явно
      задокументировано реализацией.

9. События указателя

   Если родительский виджет не содержит координаты события, его
   дочерним виджетам событие НЕ ДОЛЖНО передаваться.

   Реализация МОЖЕТ отслеживать состояние наведения на уровне виджета
   как производное от результатов `MouseMoveEvent`, но это состояние не
   влияет на нормативные правила распространения, кроме как в рамках
   логики самой реализации.

10. Отрисовка

   Виджет ДОЛЖЕН предоставлять операцию визуализации, принимающую
   абстрактный контекст вывода.

   Способ композиции не нормируется; порядок рисования СЛЕДУЕТ
   согласовать с Z-порядком, если иное не оговорено.

11. Расширяемость интерфейсов

   Реализация МОЖЕТ добавлять к виджетам следующие (неисчерпывающие)
   механизмы:

      - Список дочерних виджетов (как в разделe 4);

      - Флаг наведения;

      - Обратные вызовы, с передачей ссылки на глобальное состояние;

      - Любые дополнительные данные состояния, не нарушающие семантику
        разделов 7-9.






Коллективный разум         Предложение черновика            [Страница 5]

RFC           Модель пользовательского интерфейса          Сентябрь 2025


12. Инварианты и требования к совместимости

   Определяются следующие инварианты и требования к совместимости:

      - Геометрическая согласованность - преобразование координат
        событий и проверка попадания ДОЛЖНЫ быть непротиворечивыми
        по всей иерархии.

      - Порядок детей - коллекция детей ДОЛЖНА поддерживать убывающий
        Z-порядок.

      - Остановка распространения - как только участник возвращает
        CONSUME, никакие другие обработчики в ветви не вызываются.

      - Целевой виджет определяется только согласно разделу 8, если
        реализацией не задекларировано иное.

13. Соображения безопасности

   Обработчики событий НЕ ДОЛЖНЫ вызывать рекурсивную диспетчеризацию
   того же события без мер защиты от зацикливания.

   Мутации структуры дерева во время обхода ДОЛЖНЫ быть либо запрещены,
   либо выполняться через безопасный механизм (например, отложенная
   апликация изменений).

14. Соображения производительности

   Реализации МОГУТ кэшировать результаты проверки на попадание
   (например, через региональные индексы) при сохранении корректности
   разделов 7-9.

   Стабильность Z-порядка влечёт асимптотическую сложность O(n) обхода
   по количеству детей; крупные деревья МОГУТ требовать пространственных
   структур (BVH/quad-tree), не меняя семантику.

15. Соответствие

   Реализация считается соответствующей, если:

      - Соблюдает правила распространения (см. раздел 7), выбора цели
        (см. раздел 8) и фильтрации по попаданию (см. раздел 9);

      - Поддерживает минимум событий из раздела 6;

      - Предоставляет глобальное состояние с минимальными полями
        (см. раздел 5).



Коллективный разум         Предложение черновика            [Страница 6]

RFC           Модель пользовательского интерфейса          Сентябрь 2025


16. История изменений

   - v0.1 (черновик): первичная формализация базового виджета, событий и
     диспетчеризации.














































Коллективный разум         Предложение черновика            [Страница 7]
